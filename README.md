# MlogAssertions

> [!TIP]
> This mod supports the latest Mindustry 8 Beta release. There's also a [version](https://github.com/cardillan/MlogAssertions-7) compatible with Mindustry 7, which has fewer features and is no longer being developed.

> [!NOTE]
> Using this mod on maps with lost of processors may have a negative performance impact on the game.

Mod intended to make debugging in Mindustry Logic a bit easier. Provided functionality:

* Settings for overriding instruction limit (the limit can be increased up to 2000 instructions). This allows you to insert debugging code (e.g., additional `print` instructions) into your code, even if the original instruction limit is exceeded.
* Buttons to copy the variables (including their full, unrounded values) and the processor's text buffer to clipboard. The variables can be pasted into a spreadsheet and sorted by name for easier inspection.
* Custom mlog instructions for performing runtime checks.
* Indication of failed runtime checks, stopped processors, or processors performing a `wait`.  

![Screenshot of state indicated on processors](processors.png)

# Custom instructions

The custom instructions are used by [Mindcode](https://github.com/cardillan/mindcode) to perform runtime checks. They can be used by other compilers too or by a manually written mlog.

When a runtime check fails, the program execution stops at the given instruction, and an accompanying message is displayed above the processor.

## Instruction `assertbounds` 

This is a complex instruction, most useful to check a variable used as an index into an array is within bounds. Using out-of-bounds index for internal arrays can cause erratic, hard-to-diagnose behavior. The instruction takes these parameters:

* `type`: keyword. Specifies the required type of the value being tested: 
  * `any`: any value is allowed,
  * `notNull`: any value except `null` is allowed,
  * `decimal`: a numerical value is required,
  * `integer`: an integer value is required,
  * `multiple`: an integer value that is a specified multiple is required. 
* `multiple`: the required multiple in case `type` is `multiple`.
* `min`: the minimum allowed value.
* `opMin`: one of `lessThan` or `lessThanEq`, specifies whether the minimum value is included in the allowed range.
* `value`: the value being tested. 
* `opMax`: one of `lessThan` or `lessThanEq`, specifies whether the maximum value is included in the allowed range.
* `max`: the maximum allowed value.
* `message`: the error message to display in case the assertion fails.

## Instruction `assertequals` 

The instruction compares an actual value to an expected value and displays an error message if they are not equal. The instruction takes these parameters:

* `expected`: the expected value.
* `actual`: the actual value.
* `message`: the error message to display in case the assertion fails.

The values are compared using the `strictEqual` mlog operator.

## Instruction `assertflush`

This instruction marks the beginning of a block of code which generates text into the text buffer (using any of the printing instructions, `print`, `printchar` or `format`). The `assertprint` instruction is the used to comapre the output generted by the program to an expected string. The instruction takes these parameters:

* `position`: output variable receiving the current position in the text buffer.

## Instruction `assertprint` 

This instruction compares the output generated by the program to an expected string. The instruction takes these parameters:

* `position`: the position in the text buffer at the beginning of the tested code (must be the variable used by the `assertflush` instruction).
* `expected`: the expected string.
* `message`: the error message to display in case the assertion fails.

> [!NOTE]
> The content of the text buffer is not saved into the map file. Therefore, when a map is loaded from a save file, the `asssertprint` instruction may spuriously fail. 

## Instruction `error`

This instruction displays an error message and stops the program execution. The instruction takes these parameters:

* `message`: the error message to display.
* `p1` .. `p9`: additional parameters to display in the error message.

If the message contains placeholders in the form `[[1]` to `[[9]`, they are replaced by the corresponding parameters. If there are other parameters not used by the message, whose value is not `null`, they are appended to the message one by one.
